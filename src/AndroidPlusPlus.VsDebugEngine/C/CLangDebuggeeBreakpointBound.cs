////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.Diagnostics;
using Microsoft.VisualStudio.Debugger.Interop;
using AndroidPlusPlus.Common;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace AndroidPlusPlus.VsDebugEngine
{

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  public class CLangDebuggeeBreakpointBound : DebuggeeBreakpointBound
  {

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private readonly CLangDebugger m_debugger;

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public CLangDebuggeeBreakpointBound (CLangDebugger debugger, DebugBreakpointManager breakpointManager, DebuggeeBreakpointPending pendingBreakpoint, DebuggeeCodeContext codeContext, MiBreakpoint gdbBreakpoint)
      : base (breakpointManager, pendingBreakpoint, codeContext)
    {
      m_debugger = debugger;

      GdbBreakpoint = gdbBreakpoint;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public MiBreakpoint GdbBreakpoint { get; protected set; }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    #region IDebugBoundBreakpoint2 Members

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public override int Delete ()
    {
      // 
      // Deletes the breakpoint.
      // 

      LoggingUtils.PrintFunction ();

      try
      {
        int handle = base.Delete ();

        if (handle == DebugEngineConstants.E_BP_DELETED)
        {
          return handle;
        }

        LoggingUtils.RequireOk (handle);

        m_debugger.RunInterruptOperation (delegate ()
        {
          MiResultRecord resultRecord = m_debugger.GdbClient.SendCommand ("-break-delete " + GdbBreakpoint.ID);

          if ((resultRecord == null) || ((resultRecord != null) && resultRecord.IsError ()))
          {
            throw new InvalidOperationException ();
          }
        });

        return DebugEngineConstants.S_OK;
      }
      catch (Exception e)
      {
        LoggingUtils.HandleException (e);

        return DebugEngineConstants.E_FAIL;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public override int Enable (int fEnable)
    {
      // 
      // Enables or disables the breakpoint.
      // 

      LoggingUtils.PrintFunction ();

      try
      {
        int handle = base.Enable (fEnable);

        if (handle == DebugEngineConstants.E_BP_DELETED)
        {
          return handle;
        }

        LoggingUtils.RequireOk (handle);

        m_debugger.RunInterruptOperation (delegate ()
        {
          MiResultRecord resultRecord = m_debugger.GdbClient.SendCommand ((m_breakpointEnabled ? "-break-enable " : "-break-disable ") + GdbBreakpoint.ID);

          if ((resultRecord == null) || ((resultRecord != null) && resultRecord.IsError ()))
          {
            throw new InvalidOperationException ();
          }
        });

        return DebugEngineConstants.S_OK;
      }
      catch (Exception e)
      {
        LoggingUtils.HandleException (e);

        return DebugEngineConstants.E_FAIL;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public override int SetCondition (BP_CONDITION bpCondition)
    {
      // 
      // Sets or changes the condition associated with this bound breakpoint.
      // 

      LoggingUtils.PrintFunction ();

      try
      {
        int handle = base.SetCondition (bpCondition);

        if (handle == DebugEngineConstants.E_BP_DELETED)
        {
          return handle;
        }

        LoggingUtils.RequireOk (handle);

        string condition = string.Empty;

        switch (bpCondition.styleCondition)
        {
          case enum_BP_COND_STYLE.BP_COND_WHEN_TRUE:
          {
            condition = bpCondition.bstrCondition;

            break;
          }

          case enum_BP_COND_STYLE.BP_COND_WHEN_CHANGED:
          {
            throw new NotImplementedException ();
          }
        }

        m_debugger.RunInterruptOperation (delegate ()
        {
          MiResultRecord resultRecord = m_debugger.GdbClient.SendCommand (string.Format ("-break-condition {0} {1}", GdbBreakpoint.ID, condition));

          if ((resultRecord == null) || ((resultRecord != null) && resultRecord.IsError ()))
          {
            throw new InvalidOperationException ();
          }
        });

        return DebugEngineConstants.S_OK;
      }
      catch (NotImplementedException e)
      {
        LoggingUtils.HandleException (e);

        return DebugEngineConstants.E_NOTIMPL;
      }
      catch (Exception e)
      {
        LoggingUtils.HandleException (e);

        return DebugEngineConstants.E_FAIL;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public override int SetPassCount (BP_PASSCOUNT bpPassCount)
    {
      // 
      // Sets or change the pass count associated with this bound breakpoint.
      // 

      LoggingUtils.PrintFunction ();

      try
      {
        int handle = base.SetPassCount (bpPassCount);

        if (handle == DebugEngineConstants.E_BP_DELETED)
        {
          return handle;
        }

        LoggingUtils.RequireOk (handle);

        uint passCount = 0;

        switch (bpPassCount.stylePassCount)
        {
          case enum_BP_PASSCOUNT_STYLE.BP_PASSCOUNT_EQUAL:
          {
            goto case enum_BP_PASSCOUNT_STYLE.BP_PASSCOUNT_EQUAL_OR_GREATER;
          }

          case enum_BP_PASSCOUNT_STYLE.BP_PASSCOUNT_EQUAL_OR_GREATER:
          {
            passCount = bpPassCount.dwPassCount - 1;

            break;
          }

          case enum_BP_PASSCOUNT_STYLE.BP_PASSCOUNT_MOD:
          {
            throw new NotImplementedException ();
          }
        }

        m_debugger.RunInterruptOperation (delegate ()
        {
          MiResultRecord resultRecord = m_debugger.GdbClient.SendCommand (string.Format ("-break-after {0} {1}", GdbBreakpoint.ID, passCount));

          if ((resultRecord == null) || ((resultRecord != null) && resultRecord.IsError ()))
          {
            throw new InvalidOperationException ();
          }
        });

        return DebugEngineConstants.S_OK;
      }
      catch (NotImplementedException e)
      {
        LoggingUtils.HandleException (e);

        return DebugEngineConstants.E_NOTIMPL;
      }
      catch (Exception e)
      {
        LoggingUtils.HandleException (e);

        return DebugEngineConstants.E_FAIL;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    #endregion

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  }

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
