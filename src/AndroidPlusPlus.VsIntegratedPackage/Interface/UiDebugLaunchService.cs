////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Runtime.InteropServices;

using AndroidPlusPlus.Common;
using AndroidPlusPlus.VsDebugEngine;

using Microsoft.VisualStudio;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace AndroidPlusPlus.VsIntegratedPackage
{

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  public class UiDebugLaunchService : IUiDebugLaunchService
  {

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private UiDebugLaunchWindow m_debugLaunchWindow;

    private StringBuilder m_textBuffer;

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public UiDebugLaunchService ()
    {
      m_debugLaunchWindow = null;

      m_textBuffer = new StringBuilder ();
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    int IUiDebugLaunchService.LaunchDialogShow ()
    {
      LoggingUtils.PrintFunction ();

      try
      {
        if (m_debugLaunchWindow == null)
        {
          m_debugLaunchWindow = new UiDebugLaunchWindow ();

          m_debugLaunchWindow.Closed += LaunchWindowClosed;
        }

        lock (m_debugLaunchWindow)
        {
          m_debugLaunchWindow.textBox1.BeginChange ();

          m_debugLaunchWindow.textBox1.Text = m_textBuffer.ToString ();

          m_debugLaunchWindow.textBox1.EndChange ();

          m_debugLaunchWindow.textBox1.ScrollToEnd ();

          m_debugLaunchWindow.progressBar1.IsIndeterminate = true;

          m_debugLaunchWindow.Show ();

          m_debugLaunchWindow.Activate ();
        }

        return VSConstants.S_OK;
      }
      catch (Exception e)
      {
        LoggingUtils.HandleException (e);

        return VSConstants.E_FAIL;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    int IUiDebugLaunchService.LaunchDialogUpdate (string status, bool isError)
    {
      LoggingUtils.PrintFunction ();

      try
      {
        m_textBuffer.AppendLine (string.Format ("[{0}] {1}", ((isError) ? "error" : "status"), status));

        if (m_debugLaunchWindow != null)
        {
          lock (m_debugLaunchWindow)
          {
            m_debugLaunchWindow.textBox1.BeginChange ();

            m_debugLaunchWindow.textBox1.Text = m_textBuffer.ToString ();

            m_debugLaunchWindow.textBox1.EndChange ();

            m_debugLaunchWindow.textBox1.ScrollToEnd ();

            m_debugLaunchWindow.progressBar1.IsIndeterminate = !isError;

            m_debugLaunchWindow.Activate ();
          }
        }

        return VSConstants.S_OK;
      }
      catch (Exception e)
      {
        LoggingUtils.HandleException (e);

        return VSConstants.E_FAIL;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    int IUiDebugLaunchService.LaunchDialogClose ()
    {
      LoggingUtils.PrintFunction ();

      try
      {
        m_debugLaunchWindow.Close ();

        return VSConstants.S_OK;
      }
      catch (Exception e)
      {
        LoggingUtils.HandleException (e);

        return VSConstants.E_FAIL;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private void LaunchWindowClosed (object sender, EventArgs e)
    {
      m_textBuffer.Clear ();

      lock (m_debugLaunchWindow)
      {
        m_debugLaunchWindow = null;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  }

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

