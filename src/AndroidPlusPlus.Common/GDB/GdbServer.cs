////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using System;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace AndroidPlusPlus.Common
{

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  public sealed class GdbServer : AsyncRedirectProcess.EventListener, IDisposable
  {

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private readonly GdbSetup m_gdbSetup;

    private AsyncRedirectProcess m_gdbServerInstance;

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public GdbServer (GdbSetup gdbSetup)
    {
      LoggingUtils.PrintFunction ();

      m_gdbSetup = gdbSetup;

      m_gdbServerInstance = null;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public void Dispose ()
    {
      LoggingUtils.PrintFunction ();

      if (m_gdbServerInstance != null)
      {
        m_gdbServerInstance.Dispose ();

        m_gdbServerInstance = null;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public bool Start ()
    {
      LoggingUtils.PrintFunction ();

      if (CheckGdbServerTarget ())
      {
        KillActiveGdbServerSessions ();

        // 
        // Launch 'gdbserver' now.
        // 

        m_gdbServerInstance = AndroidAdb.AdbCommandAsync (m_gdbSetup.Process.HostDevice, "shell", string.Format ("run-as {0} lib/gdbserver --attach {1}:{2} {3} ", m_gdbSetup.Process.Name, m_gdbSetup.Host, m_gdbSetup.Port, m_gdbSetup.Process.Pid));

        m_gdbServerInstance.Listener = this;

        m_gdbServerInstance.Start ();

        LoggingUtils.Print (string.Format ("[GdbServer] Launched gdbserver succesfully."));

        return true;
      }

      return false;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public bool Stop ()
    {
      LoggingUtils.PrintFunction ();

      bool stopped = false;

      if (m_gdbServerInstance != null)
      {
        m_gdbServerInstance.Kill ();

        m_gdbServerInstance = null;

        stopped = true;
      }

      KillActiveGdbServerSessions ();

      return stopped;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private bool CheckGdbServerTarget ()
    {
      LoggingUtils.PrintFunction ();

      if (AndroidAdb.IsDeviceConnected (m_gdbSetup.Process.HostDevice))
      {
        // 
        // Check the target 'gdbserver' exits.
        // 

        try
        {
          using (SyncRedirectProcess checkGdbServer = AndroidAdb.AdbCommand (m_gdbSetup.Process.HostDevice, "shell", string.Format ("ls {0}/lib/gdbserver", m_gdbSetup.Process.InternalCacheDirectory)))
          {
            if (checkGdbServer.StartAndWaitForExit (1000) != 0)
            {
              throw new InvalidOperationException ("Could not locate 'gdbserver' target.");
            }

            if (!checkGdbServer.StandardOutput.ToLower ().Contains ("no such file"))
            {
              return true;
            }
          }
        }
        catch (Exception e)
        {
          LoggingUtils.HandleException (e);
        }
      }

      return false;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private void KillActiveGdbServerSessions ()
    {
      LoggingUtils.PrintFunction ();

      if (AndroidAdb.IsDeviceConnected (m_gdbSetup.Process.HostDevice))
      {
        m_gdbSetup.Process.HostDevice.Refresh ();

        AndroidProcess [] activeProcesses = m_gdbSetup.Process.HostDevice.GetProcesses ();

        foreach (AndroidProcess process in activeProcesses)
        {
          if (process.Name.Contains ("lib/gdbserver"))
          {
            LoggingUtils.Print (string.Format ("[GdbServer] Killing existing debugging session: ({0}).", process.Name));

            m_gdbSetup.Process.HostDevice.Shell (string.Format ("run-as {0}", process.Name), string.Format ("kill -9 {0}", process.Pid));
          }
        }
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public void ProcessStdout (object sendingProcess, DataReceivedEventArgs args)
    {
      if (!string.IsNullOrEmpty (args.Data))
      {
        LoggingUtils.Print (string.Format ("[GdbServer] ProcessStdout: {0}", args.Data));
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public void ProcessStderr (object sendingProcess, DataReceivedEventArgs args)
    {
      if (!string.IsNullOrEmpty (args.Data))
      {
        LoggingUtils.Print (string.Format ("[GdbServer] ProcessStderr: {0}", args.Data));
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public void ProcessExited (object sendingProcess, EventArgs args)
    {
      LoggingUtils.Print (string.Format ("[GdbServer] ProcessExited: {0}", args));
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  }

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
