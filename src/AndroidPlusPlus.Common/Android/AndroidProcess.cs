////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using System;
using System.IO;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace AndroidPlusPlus.Common
{
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  public class AndroidProcess
  {

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private string m_remoteApkPath;

    private string m_remoteNativeLibrariesPath;

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public AndroidProcess (AndroidDevice device, string name, uint pid, uint ppid, string user)
    {
      HostDevice = device;

      Name = name;

      Pid = pid;

      ParentPid = ppid;

      User = user;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public AndroidDevice HostDevice { get; protected set; }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private void Refresh ()
    {
      // 
      // Retrieves the install specific (coded) remote APK path.
      //   i.e: /data/app/com.example.hellogdbserver-2.apk
      // 

      if (m_remoteApkPath == null)
      {
        string applicationPath = HostDevice.Shell ("pm", string.Format ("path {0}", Name)).Replace ("\r", "").Replace ("\n", "");

        if (applicationPath.StartsWith ("package:"))
        {
          m_remoteApkPath = applicationPath.Substring ("package:".Length);
        }
        else
        {
          throw new InvalidOperationException ("Failed to retrieve remote application path");
        }
      }

      // 
      // Since Jelly Bean 4.2?, Android has a /data/app-lib/[bundle] directory where it extracts application binaries.
      // - They were moved from /data/data/[package]/lib, which no references /app-lib via symlink.
      // - Note that 'app-lib' uses the bundle id (com.example.hellogdbserver-2) rather than package address.
      // 

      if (m_remoteNativeLibrariesPath == null)
      {
        AndroidSettings.VersionCode sdkVesionCode = HostDevice.SdkVersion;

        if (sdkVesionCode >= AndroidSettings.VersionCode.LOLLIPOP)
        {
          // 
          // On Lollipop, native libraries are placed in a per-architecture folder alongside the base APK.
          // 

          string baseApkDirectory = Path.GetDirectoryName (m_remoteApkPath);

          baseApkDirectory = baseApkDirectory.Substring ("/data/app/".Length); // trim leading path

          string [] supportedCpuAbis = HostDevice.SupportedCpuAbis;

          string cpuAbiSubdirectory = string.Empty;

          foreach (string abi in supportedCpuAbis)
          {
            switch (abi)
            {
              case "armeabi":
              case "armeabi-v7a":
              {
                cpuAbiSubdirectory = "arm";

                break;
              }

              case "arm64-v8a":
              {
                cpuAbiSubdirectory = "arm64";

                break;
              }

              case "x86":
              case "x86_64":
              case "mips":
              case "mips64":
              {
                cpuAbiSubdirectory = abi;

                break;
              }
            }

            if (!string.IsNullOrEmpty (cpuAbiSubdirectory))
            {
              break;
            }
          }

          m_remoteNativeLibrariesPath = string.Format ("/data/app/{0}/lib/{1}", baseApkDirectory, cpuAbiSubdirectory);
        }
        else if (sdkVesionCode >= AndroidSettings.VersionCode.JELLY_BEAN_MR1)
        {
          string bundleId = Path.GetFileNameWithoutExtension (m_remoteApkPath);

          m_remoteNativeLibrariesPath = string.Format ("/data/app-lib/{0}", bundleId);
        }
        else
        {
          m_remoteNativeLibrariesPath = string.Format ("/data/data/{0}/lib", Name);
        }
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string RemoteApplicationPath
    {
      get
      {
        Refresh ();

        return m_remoteApkPath;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string InternalCacheDirectory
    {
      get
      {
        return "/data/data/" + Name;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string InternalNativeLibrariesDirectory
    {
      get
      {
        Refresh ();

        return m_remoteNativeLibrariesPath;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public bool IsUserProcess 
    {
      get
      {
        // 
        // Android 4.1+ applications are designated a user-based app-id (e.g. u0_a60), older SDKs prefer 'app' - assume any without these are a system process.
        // 

        return (User.StartsWith ("u") && User.Contains ("_")) || User.StartsWith ("app");
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string User { get; protected set; }

    public uint Pid { get; protected set; }

    public uint ParentPid { get; protected set; }

    //public uint Vsize { get; protected set; }

    //public uint Rss { get; protected set; }

    //public uint Wchan { get; protected set; }

    //public uint Pc { get; protected set; }

    public string Name { get; protected set; }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  }

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
