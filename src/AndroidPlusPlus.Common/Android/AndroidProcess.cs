////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using System;
using System.IO;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace AndroidPlusPlus.Common
{
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  public class AndroidProcess
  {

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private string m_remoteApplicationPath;

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public AndroidProcess (AndroidDevice device, string name, uint pid, uint ppid, string user)
    {
      HostDevice = device;

      Name = name;

      Pid = pid;

      ParentPid = ppid;

      User = user;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public AndroidDevice HostDevice { get; protected set; }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private void Refresh ()
    {
      // 
      // Retrieves the install specific (coded) remote APK path.
      //   i.e: /data/app/com.example.hellogdbserver-2.apk
      // 

      if (m_remoteApplicationPath == null)
      {
        string applicationPath = HostDevice.Shell ("pm", string.Format ("path {0}", Name)).Replace ("\r", "").Replace ("\n", "");

        if (applicationPath.StartsWith ("package:"))
        {
          m_remoteApplicationPath = applicationPath.Substring ("package:".Length);
        }
        else
        {
          throw new InvalidOperationException ("Failed to retrieve remote application path");
        }
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string RemoteApplicationPath
    {
      get
      {
        Refresh ();

        return m_remoteApplicationPath;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string InternalCacheDirectory
    {
      get
      {
        return "/data/data/" + Name;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string InternalNativeLibrariesDirectory
    {
      get
      {
        // 
        // Since Jelly Bean 4.2?, Android has a /data/app-lib/[bundle] directory where it extracts application binaries.
        // - They were moved from /data/data/[package]/lib, which no references /app-lib via symlink.
        // - Note that 'app-lib' uses the bundle id (com.example.hellogdbserver-2) rather than package address.
        // 

        Refresh ();

        string bundleId = Path.GetFileNameWithoutExtension (m_remoteApplicationPath);

        if (HostDevice.SdkVersion >= AndroidSettings.VersionCode.JELLY_BEAN_MR1)
        {
          return string.Format ("/data/app-lib/{0}", bundleId);
        }

        return string.Format ("/data/data/{0}/lib", Name);
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public bool IsUserProcess 
    {
      get
      {
        // 
        // Android 4.1+ applications are designated a user-based app-id (e.g. u0_a60), older SDKs prefer 'app' - assume any without these are a system process.
        // 

        return (User.StartsWith ("u") && User.Contains ("_")) || User.StartsWith ("app");
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string User { get; protected set; }

    public uint Pid { get; protected set; }

    public uint ParentPid { get; protected set; }

    //public uint Vsize { get; protected set; }

    //public uint Rss { get; protected set; }

    //public uint Wchan { get; protected set; }

    //public uint Pc { get; protected set; }

    public string Name { get; protected set; }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  }

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
