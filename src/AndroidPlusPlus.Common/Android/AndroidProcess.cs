////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Text;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

namespace AndroidPlusPlus.Common
{
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  public class AndroidProcess
  {

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private string m_apkPath;

    private string m_codePath;

    private string m_dataDir;

    private string m_resourcePath;

    private string m_nativeLibraryPath;

    private string m_legacyNativeLibraryDir;

    private string m_primaryCpuAbi;

    private string m_secondaryCpuAbi;

    private string m_firstInstallTime;

    private string m_lastUpdateTime;

    private string [] m_pkgFlags;

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public AndroidProcess (AndroidDevice device, string name, uint pid, uint ppid, string user)
    {
      if (device == null)
      {
        throw new ArgumentNullException ("device");
      }

      if (string.IsNullOrEmpty (name))
      {
        throw new ArgumentNullException ("name");
      }

      if (string.IsNullOrEmpty (user))
      {
        throw new ArgumentNullException ("user");
      }

      HostDevice = device;

      Name = name;

      Pid = pid;

      ParentPid = ppid;

      User = user;
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public AndroidDevice HostDevice { get; protected set; }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    private const string CODE_PATH_EXPRESSION = "      codePath=";

    private const string RESOURCE_PATH_EXPRESSION = "      resourcePath=";

    private const string DATA_DIR_EXPRESSION = "      dataDir=";

    private const string NATIVE_LIBRARY_PATH_EXPRESSION = "      nativeLibraryPath=";

    private const string LEGACY_NATIVE_LIBRARY_DIR_EXPRESSION = "      legacyNativeLibraryDir=";

    private const string PRIMARY_CPU_ABI_EXPRESSION = "      primaryCpuAbi=";

    private const string SECONDARY_CPU_ABI_EXPRESSION = "      secondaryCpuAbi=";

    private const string FIRST_INSTALL_TIME_EXPRESSION = "      firstInstallTime=";

    private const string LAST_UPDATE_TIME_EXPRESSION = "      lastUpdateTime=";

    private const string PKG_FLAGS_EXPRESSION = "      pkgFlags=";

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public void RefreshPackageInfo ()
    {
      LoggingUtils.PrintFunction ();

      StringBuilder builder = new StringBuilder (256);

      // 
      // Retrieves the install specific (coded) remote APK path.
      //   i.e: /data/app/com.example.hellogdbserver-2.apk
      // 

      builder.Length = 0;

      builder.Append (HostDevice.Shell ("pm", string.Format ("path {0}", Name)));

      builder.Replace ("\r", "");

      builder.Replace ("\n", "");

      string remoteAppPath = builder.ToString ();

      if (remoteAppPath.StartsWith ("package:"))
      {
        m_apkPath = remoteAppPath.Substring ("package:".Length);
      }

      // 
      // Retrieves the data directory associated with an installed application.
      //   i.e: /data/data/com.example.hellogdbserver/
      // 

      builder.Length = 0;

      builder.Append (HostDevice.Shell ("run-as", string.Format ("{0} /system/bin/sh -c pwd", Name)));

      builder.Replace ("\r", "");

      builder.Replace ("\n", "");

      string remoteDataDirectory = builder.ToString ();

      if (remoteDataDirectory.StartsWith ("/data/"))
      {
        m_dataDir = remoteDataDirectory;
      }

      // 
      // Perform an 'adb shell pm dump <package>' request, and parse output for relevant data.
      // - This isn't available on older devices; it's a fairly recent addition. JB+ possibly?
      // - TODO: This is extremely sub-optimal, but will have to do for now.
      // 

      if (HostDevice.SdkVersion >= AndroidSettings.VersionCode.JELLY_BEAN_MR1)
      {
        builder.Length = 0;

        builder.Append (HostDevice.Shell ("pm", string.Format ("dump {0}", Name)));

        builder.Replace ("\r", "");

        string [] packageDumpReport = builder.ToString ().Split (new char [] { '\n' }, StringSplitOptions.RemoveEmptyEntries);

        for (int i = 0; i < packageDumpReport.Length; ++i)
        {
          string line = packageDumpReport [i];

          if (line.StartsWith (CODE_PATH_EXPRESSION))
          {
            m_codePath = line.Substring (CODE_PATH_EXPRESSION.Length);
          }
          else if (line.StartsWith (DATA_DIR_EXPRESSION))
          {
            m_dataDir = line.Substring (DATA_DIR_EXPRESSION.Length);
          }
          else if (line.StartsWith (RESOURCE_PATH_EXPRESSION))
          {
            m_resourcePath = line.Substring (RESOURCE_PATH_EXPRESSION.Length);
          }
          else if (line.StartsWith (NATIVE_LIBRARY_PATH_EXPRESSION))
          {
            m_nativeLibraryPath = line.Substring (NATIVE_LIBRARY_PATH_EXPRESSION.Length);
          }
          else if (line.StartsWith (LEGACY_NATIVE_LIBRARY_DIR_EXPRESSION))
          {
            m_legacyNativeLibraryDir = line.Substring (LEGACY_NATIVE_LIBRARY_DIR_EXPRESSION.Length);
          }
          else if (line.StartsWith (PRIMARY_CPU_ABI_EXPRESSION))
          {
            m_primaryCpuAbi = line.Substring (PRIMARY_CPU_ABI_EXPRESSION.Length);
          }
          else if (line.StartsWith (SECONDARY_CPU_ABI_EXPRESSION))
          {
            string secondaryAbi = line.Substring (SECONDARY_CPU_ABI_EXPRESSION.Length);

            if (!secondaryAbi.Equals ("null"))
            {
              m_secondaryCpuAbi = secondaryAbi;
            }
          }
          else if (line.StartsWith (FIRST_INSTALL_TIME_EXPRESSION))
          {
            m_firstInstallTime = line.Substring (FIRST_INSTALL_TIME_EXPRESSION.Length);
          }
          else if (line.StartsWith (LAST_UPDATE_TIME_EXPRESSION))
          {
            m_lastUpdateTime = line.Substring (LAST_UPDATE_TIME_EXPRESSION.Length);
          }
          else if (line.StartsWith (PKG_FLAGS_EXPRESSION))
          {
            m_pkgFlags = line.Substring (PKG_FLAGS_EXPRESSION.Length).Trim (new char [] { '[', ']' }).Split (new char [] { ' ' }, StringSplitOptions.RemoveEmptyEntries);
          }
        }
      }

      // 
      // Clean up some variables which may be empty or undefined.
      // 

      if (string.IsNullOrWhiteSpace (m_dataDir))
      {
        m_dataDir = string.Format ("/data/data/{0}", Name);
      }

      if (string.IsNullOrWhiteSpace (m_codePath))
      {
        if (!string.IsNullOrWhiteSpace (m_dataDir))
        {
          m_codePath = m_dataDir;
        }
        else
        {
          m_codePath = string.Format ("/data/data/{0}", Name);
        }
      }

      if (string.IsNullOrWhiteSpace (m_primaryCpuAbi))
      {
        m_primaryCpuAbi = HostDevice.SupportedCpuAbis [0];
      }

      if (string.IsNullOrWhiteSpace (m_primaryCpuAbi) && (HostDevice.SupportedCpuAbis.Length > 1))
      {
        m_secondaryCpuAbi = HostDevice.SupportedCpuAbis [1];
      }

      if (string.IsNullOrWhiteSpace (m_legacyNativeLibraryDir))
      {
        if (HostDevice.SdkVersion >= AndroidSettings.VersionCode.JELLY_BEAN_MR1)
        {
          string bundleId = Path.GetFileNameWithoutExtension (m_apkPath);

          m_legacyNativeLibraryDir = string.Format ("/data/app-lib/{0}", bundleId);
        }
        else
        {
          m_legacyNativeLibraryDir = string.Format ("{0}/lib", m_codePath);
        }
      }

      if (string.IsNullOrWhiteSpace (m_nativeLibraryPath))
      {
        m_nativeLibraryPath = m_legacyNativeLibraryDir;

        if (HostDevice.SdkVersion >= AndroidSettings.VersionCode.JELLY_BEAN_MR1)
        {
          string cpuAbiSubdirectory = string.Empty;

          switch (m_primaryCpuAbi)
          {
            case "armeabi":
            case "armeabi-v7a":
            {
              cpuAbiSubdirectory = "arm";

              break;
            }

            case "arm64-v8a":
            {
              cpuAbiSubdirectory = "arm64";

              break;
            }

            case "x86":
            case "x86_64":
            case "mips":
            case "mips64":
            default:
            {
              cpuAbiSubdirectory = m_primaryCpuAbi;

              break;
            }
          }

          m_nativeLibraryPath = string.Format ("{0}/{1}", m_legacyNativeLibraryDir, cpuAbiSubdirectory);
        }
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string RemoteApkPath
    {
      get
      {
        return m_apkPath;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string DataDirectory
    {
      get
      {
        return m_dataDir;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string NativeLibraryPath
    {
      get
      {
        return m_nativeLibraryPath;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string PrimaryCpuAbi
    {
      get
      {
        return m_primaryCpuAbi;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string SecondaryCpuAbi
    {
      get
      {
        return m_secondaryCpuAbi;
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public bool IsUserProcess 
    {
      get
      {
        // 
        // Android 4.1+ applications are designated a user-based app-id (e.g. u0_a60), older SDKs prefer 'app' - assume any without these are a system process.
        // 

        return (User.StartsWith ("u") && User.Contains ("_")) || User.StartsWith ("app");
      }
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    public string User { get; protected set; }

    public uint Pid { get; protected set; }

    public uint ParentPid { get; protected set; }

    //public uint Vsize { get; protected set; }

    //public uint Rss { get; protected set; }

    //public uint Wchan { get; protected set; }

    //public uint Pc { get; protected set; }

    public string Name { get; protected set; }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  }

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
