<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml" />
  </ItemGroup>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <UsingTask TaskName="JavaJack" AssemblyFile="$(ANDROID_PLUS_PLUS)\msbuild\bin\{master-verbose}.MsBuild.DeployTasks.dll" />

  <UsingTask TaskName="VCMessage" AssemblyName="Microsoft.Build.CppTasks.Common, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <PropertyGroup>

    <ComputeAndroidJavaJillInputsTargets>$(ComputeAndroidJavaJillInputsTargets);ComputeAndroidManifestOutput</ComputeAndroidJavaJillInputsTargets>

    <CleanDependsOn>$(CleanDependsOn);CleanAndroidJavaJill;</CleanDependsOn>

  </PropertyGroup>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  
  <Target
    Name="_AndroidJavaJill"
    DependsOnTargets="$(ComputeAndroidJavaJillInputsTargets)">
  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="AndroidJavaJill"
    BeforeTargets="$(AndroidJavaJillBeforeTargets)"
    AfterTargets="$(AndroidJavaJillAfterTargets)"
    DependsOnTargets="_AndroidJavaJill">

    <!-- 
      Flag sources for incremental build.
    -->

    <ItemGroup>
      <AndroidJavaJill Condition="'@(AndroidJavaJill)' != ''">
        <MinimalRebuildFromTracking Condition="'%(AndroidJavaJill.MinimalRebuildFromTracking)' == '' and '$(BuildType)' == 'Build' and '$(ForceRebuild)' != 'true'">true</MinimalRebuildFromTracking>
      </AndroidJavaJill>
    </ItemGroup>

    <JavaJill
      BuildingInIDE="$(BuildingInsideVisualStudio)"
      Condition="'@(AndroidJavaJill)' != ''"
      Sources="@(AndroidJavaJill)"
      ProcessorNumber="%(AndroidJavaJill.ProcessorNumber)"
      MultiProcessorCompilation="%(AndroidJavaJill.MultiProcessorCompilation)"
      TrackerLogDirectory="%(AndroidJavaJill.TrackerLogDirectory)"
      TrackFileAccess="$(TrackFileAccess)"
      MinimalRebuildFromTracking="%(AndroidJavaJill.MinimalRebuildFromTracking)"
      OutputCommandLine="%(AndroidJavaJill.OutputCommandLine)"
      ToolPath="$(JavaHomeDir)\bin"
      ToolExe="java.exe"
      JillPath="$(AndroidSdkRoot)\build-tools\$(AndroidSdkBuildToolsVersion)\jill.jar"
      PropertiesFile="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml">
      <Output TaskParameter="OutputFiles" ItemName="AndroidJavaOutputPreprocessedClassFiles" />
      <Output TaskParameter="OutputClassPaths" ItemName="AndroidJavaOutputPreprocessedClassPaths" />
      <Output TaskParameter="SkippedExecution" PropertyName="AndroidJavaPreprocessSkippedExecution" />
    </JavaJill>

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="ComputeAndroidJavaJillOutput"
    DependsOnTargets="AndroidJavaJill">

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target Name="CleanAndroidJavaJill">

    <ItemGroup>
      <CleanAndroidJavaJillFiles 
        Include="
          $(IntDir)bin\**\*.jayce;
          $(IntDir)bin\**\*.jayce.d;"
      />
    </ItemGroup>

    <Delete Files="@(CleanAndroidJavaJillFiles)" />

    <RemoveDir Directories="%(CleanAndroidJavaJillFiles.RelativeDir)" />


  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

</Project>
