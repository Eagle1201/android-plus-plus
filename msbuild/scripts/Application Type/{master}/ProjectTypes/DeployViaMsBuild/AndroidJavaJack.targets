<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml" />
  </ItemGroup>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <UsingTask TaskName="JavaJack" AssemblyFile="$(ANDROID_PLUS_PLUS)\msbuild\bin\{master-verbose}.MsBuild.DeployTasks.dll" />

  <UsingTask TaskName="VCMessage" AssemblyName="Microsoft.Build.CppTasks.Common, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <PropertyGroup>

    <ComputeAndroidJavaJackInputsTargets>$(ComputeAndroidJavaJackInputsTargets);ComputeAndroidManifestOutput;ComputeAndroidJavaJillOutput;</ComputeAndroidJavaJackInputsTargets>

    <CleanDependsOn>$(CleanDependsOn);CleanAndroidJavaJack;</CleanDependsOn>

  </PropertyGroup>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  
  <Target
    Name="_AndroidJavaJack"
    DependsOnTargets="$(ComputeAndroidJavaJackInputsTargets)">
  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="AndroidJavaJack"
    BeforeTargets="$(AndroidJavaJackBeforeTargets)"
    AfterTargets="$(AndroidJavaJackAfterTargets)"
    DependsOnTargets="_AndroidJavaJack">

    <!-- 
      Flag sources for incremental build.
    -->

    <ItemGroup>
      <AndroidJavaJack Condition="'@(AndroidJavaJack)' != ''">
        <MinimalRebuildFromTracking Condition="'%(AndroidJavaJack.MinimalRebuildFromTracking)' == '' and '$(BuildType)' == 'Build' and '$(ForceRebuild)' != 'true'">true</MinimalRebuildFromTracking>
      </AndroidJavaJack>
    </ItemGroup>

    <!-- 
      Ensure requested output directories exist 
    -->

    <MakeDir 
      Condition="'@(AndroidJavaJack)' != ''" 
      Directories="
        %(AndroidJavaJack.OutputDexDir);
        %(AndroidJavaJack.IncrementalFolder)" 
    />

    <JavaJack
      BuildingInIDE="$(BuildingInsideVisualStudio)"
      Condition="'@(AndroidJavaJack)' != ''"
      Sources="@(AndroidJavaJack)"
      ProcessorNumber="%(AndroidJavaJack.ProcessorNumber)"
      MultiProcessorCompilation="%(AndroidJavaJack.MultiProcessorCompilation)"
      TrackerLogDirectory="%(AndroidJavaJack.TrackerLogDirectory)"
      TrackFileAccess="$(TrackFileAccess)"
      MinimalRebuildFromTracking="%(AndroidJavaJack.MinimalRebuildFromTracking)"
      OutputCommandLine="%(AndroidJavaJack.OutputCommandLine)"
      ToolPath="$(JavaHomeDir)\bin"
      ToolExe="java.exe"
      JackJar="$(AndroidSdkRoot)\build-tools\$(AndroidSdkBuildToolsVersion)\jack.jar"
      PropertiesFile="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml">
    </JavaJack>

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="ComputeAndroidJavaJackOutput"
    DependsOnTargets="AndroidJavaJack">

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target Name="CleanAndroidJavaJack">

    <ItemGroup>
      <CleanAndroidJavaJackCacheFiles 
        Include="
          $(IntDir)bin\**\*.jack;
          $(IntDir)bin\**\*.jack.d;
          $(IntDir)bin\classes\**\*.class;
          $(IntDir)bin\classes\**\*.class.d;
          $(IntDir)gen\**\*.class;
          $(IntDir)gen\**\*.class.d;"
      />
    </ItemGroup>

    <Delete Files="@(CleanAndroidJavaJackCacheFiles)" />

    <RemoveDir Directories="%(CleanAndroidJavaJackCacheFiles.RelativeDir)" />

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

</Project>
