<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml" />
  </ItemGroup>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <UsingTask TaskName="JavaBuilder" AssemblyFile="$(ANDROID_PLUS_PLUS)\msbuild\bin\{master-verbose}.MsBuild.DeployTasks.dll" />

  <UsingTask TaskName="VCMessage" AssemblyName="Microsoft.Build.CppTasks.Common, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a" />

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <PropertyGroup>

    <ComputeAndroidJavaInputsTargets>$(ComputeAndroidJavaInputsTargets);ComputeAndroidManifestOutput;</ComputeAndroidJavaInputsTargets>

    <CleanDependsOn>$(CleanDependsOn);CleanAndroidJava;</CleanDependsOn>

  </PropertyGroup>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  
  <Target
    Name="_AndroidJava"
    DependsOnTargets="$(ComputeAndroidJavaInputsTargets)">
  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="AndroidJava"
    BeforeTargets="$(AndroidJavaBeforeTargets)"
    AfterTargets="$(AndroidJavaAfterTargets)"
    DependsOnTargets="_AndroidJava">
    
    <PropertyGroup>
      <UseJackTool>true</UseJackTool>
      <UseJillTool>true</UseJillTool>
      <UseJackToolPath>$(AndroidSdkRoot)\build-tools\$(AndroidSdkBuildToolsVersion)\jack.jar</UseJackToolPath>
      <UseJillToolPath>$(AndroidSdkRoot)\build-tools\$(AndroidSdkBuildToolsVersion)\jill.jar</UseJillToolPath>
    </PropertyGroup>

    <!-- 
      Ensure requested output directories exist 
    -->

    <MakeDir 
      Condition="'@(AndroidJava)' != ''" 
      Directories="%(AndroidJava.ClassOutputDirectory);%(AndroidJava.SourceOutputDirectory)" 
    />

    <!-- 
      Flag sources for incremental build.
    -->

    <ItemGroup>
      <AndroidJava Condition="'@(AndroidJava)' != ''">
        <MinimalRebuildFromTracking Condition="'%(AndroidJava.MinimalRebuildFromTracking)' == '' and '$(BuildType)' == 'Build' and '$(ForceRebuild)' != 'true'">true</MinimalRebuildFromTracking>
      </AndroidJava>
    </ItemGroup>

    <!--
      Collate any registered .jar archives to be automatically referenced in the compilation class path.
      - Segment class paths for 'Dalvik Executable' processing as some libraries are designed to skip this step.
    -->

    <MSBuild
      Projects="$(MSBuildProjectFullPath);@(ProjectReference)"
      Targets="_ComputeRequiredJars"
      BuildInParallel="$(BuildInParallel)"
      Properties="Platform=$(Platform);Configuration=$(Configuration)"
      RebaseOutputs="true"
      UseResultsCache="false">
      <Output TaskParameter="TargetOutputs" ItemName="_ClassPathJars"/>
    </MSBuild>
    
    <ItemGroup>
      <!-- Delete any tracked references to the output file for this project. -->
      <_ClassPathJars Remove="%(AndroidJava.JarOutputFile)" />
    </ItemGroup>

    <ItemGroup Condition="'@(AndroidJava)' != ''">
      <!-- Clear any registered .jar files (so we're only left with .java source-files) -->
      <AndroidJava Remove="@(_ClassPathJars)" />
      <AndroidJava>
        <!-- Add any .jar files which have been added to the project to their respective class path category -->
        <ClassPaths>@(_ClassPathJars->Distinct()->Metadata('FullPath'));%(AndroidJava.ClassPaths);</ClassPaths>
      </AndroidJava>
    </ItemGroup>

    <!--
      Pre-process AndroidManifest generated sources first. This allows us to segment which outputs should be archived.
    -->

    <JavaBuilder
      BuildingInIDE="$(BuildingInsideVisualStudio)"
      Condition="('@(AndroidJava)' != '' and '%(DisableJarExport)' == 'true')"
      Sources="@(AndroidJava)"
      ProcessorNumber="%(AndroidJava.ProcessorNumber)"
      MultiProcessorCompilation="%(AndroidJava.MultiProcessorCompilation)"
      TrackerLogDirectory="%(AndroidJava.TrackerLogDirectory)"
      TrackFileAccess="$(TrackFileAccess)"
      MinimalRebuildFromTracking="%(AndroidJava.MinimalRebuildFromTracking)"
      OutputCommandLine="%(AndroidJava.OutputCommandLine)"
      ToolPath="$(ANDROID_PLUS_PLUS)\toolchain\bin"
      ToolExe="app-java-builder.exe"
      JavaHomeDir="$(JavaHomeDir)"
      UseJack="$(UseJackTool)"
      UseJackPath="$(UseJackToolPath)"
      PropertiesFile="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml">
      <Output TaskParameter="OutputFiles" ItemName="AndroidJavaOutputPreprocessedClassFiles" />
      <Output TaskParameter="OutputClassPaths" ItemName="AndroidJavaOutputPreprocessedClassPaths" />
      <Output TaskParameter="SkippedExecution" PropertyName="AndroidJavaPreprocessSkippedExecution" />
    </JavaBuilder>

    <!-- 
      Compile all other explicit sources. Outputs a list of absolute locations to generated .class files to be archived. 
      
      When requested, archive the exported class files. This is only usually relevant for building library projects.
      - Ignore any per-Manifest resource classes (i.e. R.class, R$styleable.class, etc) as these can cause DEX conflicts.
    -->

    <JavaBuilder
      BuildingInIDE="$(BuildingInsideVisualStudio)"
      Condition="('@(AndroidJava)' != '' and '%(DisableJarExport)' != 'true')"
      Sources="@(AndroidJava)"
      ProcessorNumber="%(AndroidJava.ProcessorNumber)"
      MultiProcessorCompilation="%(AndroidJava.MultiProcessorCompilation)"
      TrackerLogDirectory="%(AndroidJava.TrackerLogDirectory)"
      TrackFileAccess="$(TrackFileAccess)"
      MinimalRebuildFromTracking="%(AndroidJava.MinimalRebuildFromTracking)"
      OutputCommandLine="%(AndroidJava.OutputCommandLine)"
      ToolPath="$(ANDROID_PLUS_PLUS)\toolchain\bin"
      ToolExe="app-java-builder.exe"
      JavaHomeDir="$(JavaHomeDir)"
      UseJack="$(UseJackTool)"
      UseJackPath="$(UseJackToolPath)"
      OutputJar="%(AndroidJava.JarOutputFile)"
      PropertiesFile="$(MSBuildThisFileDirectory)$(MSBuildThisFileName).xml">
      <Output TaskParameter="OutputFiles" ItemName="AndroidJavaOutputClassFiles" />
      <Output TaskParameter="OutputClassPaths" ItemName="AndroidJavaOutputClassPaths" />
      <Output TaskParameter="SkippedExecution" PropertyName="AndroidJavaSkippedExecution" />
    </JavaBuilder>

    <Message
      Condition="'%(AndroidJava.JarOutputFile)' != ''"
      Text="$(MSBuildProjectFile) -&gt; %(AndroidJava.JarOutputFile)"
      Importance="High"
    />

  </Target>
  
  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="_ComputeRequiredJars"
    Returns="@(_RequiredJars->Distinct())"
    DependsOnTargets="">
    <ItemGroup>
      <_RequiredJars Include="@(AndroidJava)" Condition="'%(Extension)' =='.jar'" />
      <!-- Allows 'output' files from third-party referenced projects to be added appropriately. -->
      <_RequiredJars Include="%(AndroidJava.JarOutputFile)" />
    </ItemGroup>
  </Target>
  
  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->
  
  <Target
    Name="_ComputePermittedDexJars"
    Returns="@(_PermittedDexJars->Distinct())"
    DependsOnTargets="">
    <ItemGroup>
      <!-- Collate any registered .jar files which are explicitly marked to allow DEX processing. -->
      <_PermittedDexJars Include="@(AndroidJava)" Condition="('%(Extension)' =='.jar' AND '%(DisableDexExport)' == 'false')" />
      <!-- Allows 'output' files from third-party referenced projects to be added appropriately. -->
      <_PermittedDexJars Include="%(AndroidJava.JarOutputFile)" />
    </ItemGroup>
  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target
    Name="ComputeAndroidJavaOutput"
    DependsOnTargets="AndroidJava">

    <!-- 
      Pass-through any .jar for DEX processing. Though we need to do an initial shrinking/optimisation pass using ProGuard first.
    -->

    <MSBuild
      Projects="$(MSBuildProjectFullPath);@(ProjectReference)"
      Targets="_ComputePermittedDexJars"
      BuildInParallel="$(BuildInParallel)"
      Properties="Platform=$(Platform);Configuration=$(Configuration)"
      RebaseOutputs="true"
      UseResultsCache="false">
      <Output TaskParameter="TargetOutputs" ItemName="_PermittedDexJars"/>
    </MSBuild>

    <ItemGroup>
      <!-- Delete any tracked references to the output file for this project. -->
      <_PermittedDexJars Remove="%(AndroidJava.JarOutputFile)" />
    </ItemGroup>

    <ItemGroup>
      <AndroidProguard Include="@(_PermittedDexJars)" />
    </ItemGroup>

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

  <Target Name="CleanAndroidJava">

    <ItemGroup>
      <CleanAndroidJavaCacheFiles 
        Include="
        $(IntDir)bin\classes\**\*.class;
        $(IntDir)bin\classes\**\*.class.d;
        $(IntDir)gen\**\*.class;
        $(IntDir)gen\**\*.class.d;" 
      />
    </ItemGroup>

    <Delete Files="@(CleanAndroidJavaCacheFiles)" />

    <RemoveDir Directories="%(CleanAndroidJavaCacheFiles.RelativeDir)" />

  </Target>

  <!--
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  -->

</Project>
